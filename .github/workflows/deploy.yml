name: 🚒 Deploy Feuerwehr Hamberg System

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🔧 Setup Pages
        uses: actions/configure-pages@v4

      - name: 🏗️ Build Site
        run: |
          # Create build directory
          mkdir -p _site

          # Copy all files except sensitive ones
          cp index.html _site/
          cp styles.css _site/
          cp script.js _site/
          cp README.md _site/

          # Create config.js with token placeholder (for security)
          cat > _site/config.js << 'EOF'
          // GitHub Configuration - Auto-generated during deployment
          window.GITHUB_CONFIG = {
              token: 'REQUIRES_USER_TOKEN', // User will be prompted for token
              repoOwner: 'plankl',
              repoName: 'ehrenamtskarte_ff_hamberg_v2',
              dataBranch: 'data',
              dataFolder: 'data',
              accessPassword: 'FEUERWEHR_ACCESS_PASSWORD_PLACEHOLDER' // Will be replaced with actual password
          };
          EOF
          
          # Replace password placeholder with actual secret (if available)
          if [ -n "${{ secrets.FEUERWEHR_ACCESS_PASSWORD }}" ]; then
            sed -i 's/FEUERWEHR_ACCESS_PASSWORD_PLACEHOLDER/${{ secrets.FEUERWEHR_ACCESS_PASSWORD }}/g' _site/config.js
            echo "✅ Feuerwehr access password configured"
          else
            echo "⚠️ FEUERWEHR_ACCESS_PASSWORD secret not set - password validation will be skipped"
          fi

          # Create robots.txt for privacy
          cat > _site/robots.txt << 'EOF'
          User-agent: *
          Disallow: /
          EOF

          echo "✅ Build completed successfully"

      - name: 📤 Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: 🚀 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
